# 프록시와 연관관계 관리

#### 배우는 내용

- 프록시와 즉시로딩, 지연로딩
- 영속성 전이와 고아 객체



## 프록시

지연로딩 : 엔티티를 조회할때 연관된 엔티티들이 항상 사용되지 않으므로 연관된 엔티티가 실제 사용될때까지 데이터베이스 조회를 지연하는 방법

프록시 객체 : 지연로딩 기능을 사용하기 위해 실제 엔티티 객체 대신에 데이터베이스 조회를 지연하는 가짜 객체

#### 프록시 특징

- 프록시 클래스는 실제 클래스를 상속 받아 만들어지며 실제 객체에 대한 참조를 보관하고 있다.
- 프록시 객체는 처음 사용할때 한 번만 초기화 된다.
- 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 프록시가 아닌 실제 엔티티를 반환한다.
- 초기화 할때는 영속성 컨텍스트의 도움을 받아야 하므로 프록시는 영속상태여야 한다.

#### 프록시 초기화

그림 첨부

<br/>

<br/>

## 즉시로딩과 지연로딩

<br/>

#### 즉시로딩

즉시로딩 : 엔티티를 조회할 때 연관된 엔티티도 함께 조회한다.

- 설정방법 `@ManyToOne(fetch = FetchType.EAGER)`

대부분의 JPA 구현체는 즉시 로딩을 **최적화하기 위해 가능하면 조인 쿼리를 사용**한다.

Null 제약조건과 JPA 조인 전략

- 연관된 엔티티를 즉시 조회한다. 하이버네이트는 가능하면 sql 조인을 사용해서 한번에 조회한다.

<br/>

#### 지연로딩

지연로딩 : 연관된 엔티티를 실제 사용할 때 조회한다.

- 설정 방법 `@ManyToOne(fetch = FetchType.LAZY)`
- 연관된 엔티티를 프록시로 조회한다. 프록시를 실제 사용할 때 초기화 하면서 데이터베이스를 조회한다.

<br/>

#### JPA 기본 페치 전략

- @ManyToOne, @OneToOne : 즉시 로딩
- @OneToMany @ManyToMany : 지연 로딩

추천하는 방법은 **모든 연관관계에 지연 로딩을 사용하는것** 그리고 애플리케이션 개발이 어느 정도 완료단계에 오면 꼭 필요한 곳에만 즉시 로딩을 사용

<br/>

<br/>

## 영속성 전이 : CASCADE

영속성 전이 : 특정 엔티티를 영속 상태로 만들때 연관된 엔티티도 함께 영속 상태로 만드는 것

